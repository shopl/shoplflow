name: Test Changed Packages with Turbo on PR

on:
  push:

#  pull_request:
#    types: [ opened, synchronize ] # PR이 오픈되거나 커밋이 추가될 때

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: yarn install

      - name: Test changed packages with Turbo and save results
        run: yarn turbo run test | tee test-results.txt

      - name: Parse test results
        id: parse-results
        run: |
          while IFS= read -r line; do
            echo "TEST_RESULTS_MESSAGE_${RANDOM}=${line}" >> $GITHUB_ENV
          done < <(grep -E 'PASS|Test Suites|Tests|Snapshots|Time|Ran all test suites|Tasks|Cached' test-results.txt)
     

      - name: Send test results to Slack
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: workflow,job,commit,repo,ref,author,took
          custom_payload: |
            {
              attachments: [{
                title: ":white_check_mark: 테스트가 완료되었습니다",
                color: '${{ job.status }}' === 'success' ? 'good' : '${{ job.status }}' === 'failure' ? 'danger' : 'warning',
                text: "${{ env.TEST_RESULTS_MESSAGE }}",
                actions: [
                  {
                    type: "button",
                    text: "테스트 결과 확인하기",
                    url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  },
                  {
                    type: "button",
                    text: "PR 확인하기",
                    url: "${{ github.event.pull_request.html_url }}"
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
